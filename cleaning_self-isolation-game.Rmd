---
title: "Public_Goods_Cleaning"
author: "Simon van Baal"
date: "19/11/2020"
output: html_document
---

```{r libraries}
library(tidyverse)
#renv::init()
```

```{r loading data files}
raw_data_survey <- read_csv('./raw-data/SurveysExperiment1.csv')
raw_data_game <- read_csv("./raw-data/gameData1.csv")

```


```{r Data Cleaning Experiment 1}
raw_data_survey <- 
  raw_data_survey %>%
  select(session.code,
         participant.code,
         player.age,
         player.gender,
         player.covid_positive,
         player.location,
         player.attention_check)

raw_data_game <- 
  raw_data_game %>%
  filter(session.is_demo == 0) %>%
  select(session.code,
         participant.code,
         participant.payoff,
         subsession.round_number,
         player.id_in_group,
         player.infected,
         player.timeout,
         player.cumulative_earnings,
         player.others_prediction,
         player.contribution,
         player.others_contribution_percentage,
         player.actual_payment,
         player.payoff,
         player.transmission_chance,
         player.second_player_contribution_0,
         player.second_player_contribution_1,
         player.second_player_contribution_2,
         player.second_player_contribution_3,
         player.second_player_contribution_4,
         group.total_contribution,
         group.total_infections,
         group.end_total_infections,
         group.total_earnings,
         group.lockdown,
         group.lockdown_number,
         group.lockdown_cost,
         group.patient_zero_switch)
```

```{r Exclusions on basis of participation}
# Excluding participants who did not finish the experiment, or complete
# enough of it.

# We exclude on the basis of timeouts; participants who have not completed more 
# than 70% of trials are regarded as participants who did not finish.
DNF <- 
  raw_data_game %>% 
  group_by(participant.code, session.code) %>% 
  summarise(nTimeout = sum(player.timeout)) %>% 
  filter(nTimeout < 12)

# We multiply by ten to indicate the number of points sacrificed.
cleaned_data_game <-
  raw_data_game %>%
  right_join(DNF,
             by = c("participant.code",
                    "session.code")) %>%
  arrange(participant.code, subsession.round_number) %>%
  mutate(
    lastRoundOthers =
      lag(player.others_contribution_percentage),
    player.contribution = player.contribution * 10,
    player.others_prediction = player.others_prediction * 10,
    player.second_player_contribution_0 = player.second_player_contribution_0 *
      10,
    player.second_player_contribution_1 = player.second_player_contribution_1 *
      10,
    player.second_player_contribution_2 = player.second_player_contribution_2 *
      10,
    player.second_player_contribution_3 = player.second_player_contribution_3 *
      10,
    player.second_player_contribution_4 = player.second_player_contribution_4 *
      10
  )


cleaned_data_game <-
  left_join(cleaned_data_game,
            raw_data_survey,
            by = c("session.code", "participant.code")) %>%
  mutate(Order = factor(
    ifelse(
      subsession.round_number <= 20 &
        group.lockdown_cost == 60 |
        subsession.round_number > 20 &
        group.lockdown_cost == 90,
      "Low Cost First",
      "High Cost First"
    )
  ))

```

```{r Exclusions, include = FALSE}
# Identify participants with low effort responses.

# If participants give the same answers for the hypothetical decisions at least 
# 95% of the time, their hypothetical decisions will be discarded, but the other 
# DVs will be retained. The same applies for the other DVs, where we will remove
# low-effort responses identified in this way.

# For incentivised self-isolation:
perResponse <-
  cleaned_data_game %>%
  filter(group.lockdown == 0) %>%
  group_by(participant.code, player.contribution,
           player.attention_check) %>%
  summarise(n = n()) %>%
  filter(!is.na(player.contribution))

nTrials <-
  perResponse %>%
  group_by(participant.code, player.attention_check) %>%
  summarise(numberOfResponsesIncentivised = sum(n))

toBeExcluded1 <-
  perResponse %>%
  left_join(nTrials) %>%
  filter(n >= .95*numberOfResponsesIncentivised)

# For predictions of others' self-isolation
perResponse <-
  cleaned_data_game %>%
  filter(group.lockdown == 0) %>%
  group_by(participant.code, player.others_prediction) %>%
  summarise(n = n()) %>%
  filter(!is.na(player.others_prediction))

nTrials <-
  perResponse %>%
  group_by(participant.code) %>%
  summarise(numberOfResponsesPredict = sum(n))

toBeExcluded2 <-
  left_join(perResponse, nTrials) %>%
  filter(n >= .95*numberOfResponsesPredict)

# We will use H2bdata to do the same for the hypotheticals.
# Borrowing this dataset creation from the analysis .
H2bData <-
  cleaned_data_game %>%
  filter(group.lockdown == 0) %>%
  pivot_longer(
    cols = c(
      "player.second_player_contribution_0",
      "player.second_player_contribution_1",
      "player.second_player_contribution_2",
      "player.second_player_contribution_3",
      "player.second_player_contribution_4"
    ),
    names_to = "AssumedOthersSelfIsolation",
    values_to = "HypotheticalSelfIsolation"
  ) %>%
  mutate(AssumedOthersSelfIsolation = as.numeric(substr(
    AssumedOthersSelfIsolation,
    start = 35,
    stop = 36
  )))

perResponse <-
  H2bData %>%
  filter(group.lockdown == 0) %>%
  group_by(participant.code, HypotheticalSelfIsolation) %>%
  summarise(n = n()) %>%
  filter(!is.na(HypotheticalSelfIsolation))

nTrials <-
  perResponse %>%
  group_by(participant.code) %>%
  summarise(numberOfResponsesHypothetical = sum(n))

toBeExcluded3 <-
  left_join(perResponse, nTrials) %>%
  mutate(percIdentical = n/numberOfResponsesHypothetical) %>%
  filter(n >= .95*numberOfResponsesHypothetical)

# No participants needed to be excluded according to these criteria.


# If necessary, it's possible to assess the robustness of results to excluding
# participants who failed the attention check (uncomment below). 
# The results appear the same. 

# dataAttentionCheck <-
#   cleaned_data_game %>%
#   filter(player.attention_check == "Chicago")

rm(perResponse, nTrials, toBeExcluded1, toBeExcluded2, toBeExcluded3, DNF)

```



```{r write csv}

write_csv(cleaned_data_game, './cleaned-data/cleaned_data_self-iso-game.csv')
rm(raw_data_game, raw_data_survey, cleaned_data_game, H2bData)

```